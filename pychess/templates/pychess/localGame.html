{% extends "pychess/layout.html "%}
{% load static %}


{% block title %}
Play Chess!
{% endblock %}


{% block body %}
    You are starting a local game
    <div id="board">

    </div>

    {% csrf_token %}


    <script>
        var checkingMove = false;
        var gameState = {};
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        drawBoard();

        let statePromise = getGameState();
        statePromise.then((state) => {
            gameState = state;
            drawPieces(state);
        });

        //returns a promise that will contain a JSON object with the current game state once fulfilled
        async function getGameState()
        {
            const response = await fetch("{% url 'gameState' %}");
            const state = await response.json();
            return state;
        }

        //renders the checkerboard pattern on the screen, in the form of an HTML table
        function drawBoard()
        {
            let board = document.createElement("table");
            let isLight=true;
            let cellSize;
            if (window.innerHeight < window.innerWidth)
            {
                cellSize = `${window.innerHeight / 10}px`;
            }
            else
            {
                cellSize = `${window.innerWidth / 10}px`;
            }

            for (let i = 0; i < 8; i++)
            {
                let row = document.createElement("tr");
                for (let j = 0; j < 8; j++)
                {
                    let cell = document.createElement("td");
                    cell.style.width = cellSize;
                    cell.style.height = cellSize;
                    cell.id = `p${j}_${i}`;
                    if(isLight)
                        cell.style.backgroundColor = "#FFFFFF";
                    else
                        cell.style.backgroundColor = "#000000"

                    cell.addEventListener('click', (event) => clickCell(event, cell.id));

                    row.append(cell);
                    isLight = !isLight;
 
                }
                board.append(row);
                isLight = !isLight;
            }

            document.querySelector('#board').append(board);
        }

        //reads each piece position from the gameState, and adds <img> tags with click handlers to represent each piece to the board
        function drawPieces(gameState)
        {
            //grab an array of the keys from the gameState object to iterate through
            pieces = Object.keys(gameState);

            //index 0 is "turnNumber", so start from index 1
            for(let i = 1; i < pieces.length; i++)
            {
                //only draw a piece if it has not been captured
                if(!gameState[pieces[i]]['captured'])
                {
                    //create an image tag for each piece
                    const pieceCode = pieces[i][0] + pieces[i][1];
                    const image = getImage(pieceCode);
                    
                    //when the piece is clicked, call clickPiece() and pass in all the information we have about the piece in question
                    image.addEventListener('click', (event) => clickPiece(event, pieces[i], gameState[pieces[i]]))

                    //find the correct space to place it, and append the image file
                    document.querySelector(`#p${gameState[pieces[i]]['rank']}_${gameState[pieces[i]]['file']}`).append(image);
                }
            }
        }

        //long switch statement to pick out the correct image for a piece based on its ID
        function getImage(pieceCode)
        {
            image = document.createElement("img");

            switch (pieceCode)
                {
                    case 'dp':
                        image.src="{% static '/pychess/images/pawn_dark.png' %}";
                        break;
                    case 'lp':
                        image.src="{% static '/pychess/images/pawn_light.png' %}";
                        break;
                    case 'dr':
                        image.src="{% static '/pychess/images/rook_dark.png' %}";
                        break;
                    case 'lr':
                        image.src="{% static '/pychess/images/rook_light.png' %}";
                        break;
                    case 'dn':
                        image.src="{% static '/pychess/images/knight_dark.png' %}";
                        break;
                    case 'ln':
                        image.src="{% static '/pychess/images/knight_light.png' %}";
                        break;
                    case 'db':
                        image.src="{% static '/pychess/images/bishop_dark.png' %}";
                        break;
                    case 'lb':
                        image.src="{% static '/pychess/images/bishop_light.png' %}";
                        break;
                    case 'dq':
                        image.src="{% static '/pychess/images/queen_dark.png' %}";
                        break;
                    case 'lq':
                        image.src="{% static '/pychess/images/queen_light.png' %}";
                        break;
                    case 'dk':
                        image.src="{% static '/pychess/images/king_dark.png' %}";
                        break;
                    case 'lk':
                        image.src="{% static '/pychess/images/king_light.png' %}";
                        break;
                    default:
                        break;
                }

            return image;
        }

        //click handler for an empty cell
        function clickCell(event, position)
        {
            if (checkingMove === true)
            {

                checkingMove = false
                console.log(position);
            //  fetch submitMove, passing the piece and position as POST parameters
            //  get the board state and redraw.
            //  if the move was invalid, do nothing and let the player try again
            //  if the move was valid, begin polling the db on a set interval to check for a move made by the opposing player
            }
        }

        //click handler for any of the pieces on the board
        function clickPiece(event, pieceID, pieceInfo)
        {
            //pieceID will be the unique ID of the specific piece we're working with (eg 'lp1', 'db2', etc)
            //pieceInfo is a JSON object containing that pieces current rank, file, and a boolean to represent whether it's been captured

            //this line prevents the clickCell() handler from firing at the same time as clickPiece()
            event.stopPropagation();

            //when piece is clicked
            if (checkingMove === false)
            {
                //this wacky statement looks at the turn number & the first character of the pieceID
                //if the turn number is even, it's light to move, otherwise its dark to move
                //first character of pieceID will be 'l' for light or 'd' for dark
                if((gameState['turnNumber'] % 2 === 0 && pieceID[0] === 'l') || (gameState['turnNumber'] % 2 === 1 && pieceID[0] === 'd'))
                {
                    checkingMove = true
                    checkMoves(pieceID, pieceInfo);
                }
            }

        }

        //makes a call to the back end to get a list of valid coordinates a piece can move to, and then colors those squares green
        function checkMoves(pieceID, pieceInfo)
        {
            
            fetch("{% url 'checkMoves' %}", {
                method:'POST',
                headers: {'X-CSRFToken':csrftoken},
                mode: 'same-origin',
                body: JSON.stringify({
                    id:pieceID,
                    info:pieceInfo
                })
            })
            .then(response => response.json())
            .then(moveList => {
                console.log(pieceInfo);
                moveList['validMoves'].forEach((move) => {
                    cellToHighlight = document.querySelector(`#p${pieceInfo['rank'] + move[0]}_${pieceInfo['file'] + move[1]}`);
                    cellToHighlight.style.backgroundColor = 'green';
                })
            })
        }

    </script>
{% endblock %}