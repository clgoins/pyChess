{% extends "pychess/layout.html "%}
{% load static %}


{% block title %}
Play Chess!
{% endblock %}


{% block body %}
    <main class="gameContainer">
        
        <div class="board" id="board">

        </div>

        <div class="info" id="info">
            <h2 id="status">
                <strong id="player"></strong> to move
            </h2>
        </div>
    </main>
    {% csrf_token %}


    <script>
        var gameState = {};
        var checkingMove = false;
        var activePiece = null;
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        var gameID = '{{ gameID }}'

        //Begin the game by calling getGameState(), which will return a fresh board. Then draw the board and the pieces on it.
        let statePromise = getGameState();
        statePromise.then((state) => {
            gameState = state;

            //Update the status message with whose turn it is
            if(gameState['turnNumber'] % 2 == 0)
                document.querySelector("#player").innerHTML = 'Light';
            else
                document.querySelector("#player").innerHTML = 'Dark';

            drawBoard();
            drawPieces(state);
        });


        //returns a promise that will contain a JSON object with the current game state once fulfilled
        async function getGameState()
        {
            const response = await fetch(`/gameState?gameID=${gameID}`);
            const state = await response.json();
            return state;
        }


        //renders the checkerboard pattern on the screen, in the form of an HTML table
        function drawBoard()
        {
            let board = document.createElement("table");
            let isLight=true;
            let cellSize;

            //Determine cellSize based on the size of the window
            if (window.innerHeight < window.innerWidth)
            {
                cellSize = `${window.innerHeight / 10}px`;
            }
            else
            {
                cellSize = `${window.innerWidth / 10}px`;
            }

            //Couple of nested for loops to draw an 8x8 grid of cells, alternating light and dark
            for (let i = 0; i < 8; i++)
            {
                let row = document.createElement("tr");
                for (let j = 0; j < 8; j++)
                {
                    let cell = document.createElement("td");
                    cell.style.width = cellSize;
                    cell.style.height = cellSize;

                    //HTML ID's cannot start with a number for some reason, so the id is prefixed with a 'p'
                    cell.id = `p${j}_${i}`;

                    //Picks the background color for the cell
                    if(isLight)
                        cell.style.backgroundColor = "#b3a58f";
                    else
                        cell.style.backgroundColor = "#30538c"

                    //Once the size and color of the cell has been created, add a click handler to it
                    cell.addEventListener('click', (event) => clickCell(event, cell.id));

                    row.append(cell);
                    isLight = !isLight;
 
                }
                board.append(row);
                isLight = !isLight;
            }

            //Clear off the existing board before redrawing it
            document.querySelector('#board').innerHTML = '';
            document.querySelector('#board').append(board);
        }


        //reads each piece position from the gameState, and adds <img> tags with click handlers to represent each piece to the board
        function drawPieces()
        {
            //grab an array of pieces from the gameState object to iterate through
            pieces = gameState['pieces']

            for(let i = 0; i < pieces.length; i++)
            {
                //only draw a piece if it has not been captured
                if(!pieces[i]['captured'])
                {
                    //create an image tag for each piece
                    const image = document.createElement("img");
                    image.src=`/static/pychess/images/${pieces[i]['type']}_${pieces[i]['color']}.png`
                    
                    //when the piece is clicked, call clickPiece() and pass in i as the id number
                    image.addEventListener('click', () => clickPiece(i));

                    //find the correct space to place it, and append the image file
                    document.querySelector(`#p${pieces[i]['rank']}_${pieces[i]['file']}`).append(image);
                }
            }
        }


        //click handler for an empty cell
        function clickCell(event, cellID)
        {

            // ClickCell should only do anything if the player has already clicked a piece and is now selecting from a highlighted list of valid moves.
            if (checkingMove === true && activePiece != null)
            {

                checkingMove = false;

                // cellID will be a string 'pX_Y' where X and Y are the cells coordinates. The 'p' is there because an HTML id has to start with a letter for some reason. (p = position)
                let posX = parseInt(cellID[1]);
                let posY = parseInt(cellID[3]);

                // Fetch submitMove, passing the piece, position, and gameID as POST parameters
                // Note that submitMove wants the gameID and NOT the gameState. The state will be recreated on the backend to ensure the move is valid 
                // in the event that the request is modified in some way. (To prevent cheating)
                fetch("{% url 'submitMove' %}", {
                    method:'POST',
                    headers: {'X-CSRFToken':csrftoken},
                    mode: 'same-origin',
                    body: JSON.stringify({
                        piece:activePiece,
                        rank:posX,
                        file:posY,
                        game:parseInt(gameID)
                    })
                })
                .then(response => response.json())
                .then(result =>         {
                    
                    let statePromise = getGameState();
                    statePromise.then((state) => {
                    gameState = state;

                    //If the move was submitted successfully, the turn is complete and a few things are set up for the start of the next turn.
                    if(result['message'] === "success")
                    {
                        //Figure out whose turn it is and display it on the screen
                        let turn = ''
                        if (gameState['turnNumber'] % 2 == 0)
                        {
                            turn = 'light'
                            document.querySelector("#player").innerHTML = "Light ";
                        }
                        else
                        {
                            turn = 'dark'
                            document.querySelector("#player").innerHTML = "Dark";
                        }

                        //Check for a checkmate or stalemate, and update the status message accordingly.
                        fetch("{% url 'checkForWinCondition' %}", {
                            method:'POST',
                            headers: {'X-CSRFToken':csrftoken},
                            mode: 'same-origin',
                            body: JSON.stringify({
                            state:gameState,
                            color:turn           
                            })
                        })
                        .then(response => response.json())
                        .then(winCondition => {
                            if (winCondition['message'] === "checkmate")
                            {
                                let winner = "";
                                if (turn === 'light')
                                    winner = "Dark";
                                else
                                    winner = 'Light';

                                document.querySelector("#status").innerHTML = `${winner} wins by checkmate`
                            }
                            else if (winCondition['message'] === "stalemate")
                                document.querySelector("#status").innerHTML = "Game ends in a stalemate"
                        })
                    }

                    drawBoard();
                    drawPieces(state);
                    });
                });
            }
        }


        //click handler for any of the pieces on the board
        function clickPiece(pieceID)
        {
        
            //Make sure there isn't already a piece selected
            if (checkingMove === false)
            {
                //this line prevents the clickCell() handler from firing at the same time as clickPiece()
                event.stopPropagation();

                // grab the specific piece from the gameState so there aren't so many brackets in the next if statement
                let piece = gameState['pieces'][pieceID];

                // Makes sure that if it's Light to move, that clicks only register on light pieces, or only on dark pieces if it's Dark to move
                if((gameState['turnNumber'] % 2 === 0 && piece['color'] === 'light') || (gameState['turnNumber'] % 2 === 1 && piece['color'] === 'dark'))
                {
                    checkingMove = true
                    activePiece = piece;
                    cellToHighlight = document.querySelector(`#p${piece['rank']}_${piece['file']}`);
                    cellToHighlight.style.backgroundColor = 'aliceBlue';
                    checkMoves(piece['id']);
                }
            }

        }


        //makes a call to the backend to get a list of valid coordinates a piece can move to, and then colors those squares green
        function checkMoves(pieceID)
        {
            fetch("{% url 'checkMoves' %}", {
                method:'POST',
                headers: {'X-CSRFToken':csrftoken},
                mode: 'same-origin',
                body: JSON.stringify({
                    state:gameState,
                    pieceID:pieceID
                })
            })
            .then(response => response.json())
            .then(moveList => {
                moveList['validMoves'].forEach((move) => {
                    cellToHighlight = document.querySelector(`#p${move[0]}_${move[1]}`);
                    cellToHighlight.style.backgroundColor = 'springGreen';
                })
            })
        }

    </script>
{% endblock %}